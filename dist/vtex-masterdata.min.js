// VtexMasterdata.js
// version: 0.1.0
// author: Wellington Barreto
// license: MIT
!function e(t,r,n){function a(o,i){if(!r[o]){if(!t[o]){var u="function"==typeof require&&require;if(!i&&u)return u(o,!0);if(s)return s(o,!0);var l=new Error("Cannot find module '"+o+"'");throw l.code="MODULE_NOT_FOUND",l}var f=r[o]={exports:{}};t[o][0].call(f.exports,function(e){var r=t[o][1][e];return a(r||e)},f,f.exports,e,t,r,n)}return r[o].exports}for(var s="function"==typeof require&&require,o=0;o<n.length;o++)a(n[o]);return a}({1:[function(e,t,r){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(r,"__esModule",{value:!0});var a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},s=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=function(){function e(t){if(n(this,e),this.name="VtexMasterdata Error",this.response=null,this.message=null,"object"==(void 0===t?"undefined":a(t)))for(var r in t)t.hasOwnProperty(r)&&"function"!=typeof t[r]&&("responseText"==r&&(this.response=$.parseJSON(t[r])),"string"==typeof r&&"message"==r.toLowerCase()?this.message=t[r]:this[r]=t[r]);else"string"==typeof t&&(this.message=t)}return s(e,[{key:"isOk",value:function(){return!1}},{key:"getResponse",value:function(){return this.response}},{key:"getMessage",value:function(){return null!==this.message?this.message:null!==this.response&&void 0!==this.response.Message?this.response.Message:null}}]),e}();r.default=o},{}],2:[function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(r,"__esModule",{value:!0});var s=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=e("./../data/constants.js"),i=n(o),u=e("./../utils/helpers.js"),l=n(u),f=e("./VtexSuccess.js"),c=n(f),p=e("./VtexError.js"),d=n(p),_=function(){function e(){a(this,e),this.storeName=null,this._validate(),this.vtexHelpers=new VtexHelpers}return s(e,[{key:"_validate",value:function(){if(void 0===window.VtexHelpers)throw new Error("VtexHelpers is required. Download it from https://www.npmjs.com/package/vtex-helpers")}},{key:"setStore",value:function(e){if("string"!=typeof e||0===e.length)throw new Error("Store name must be a string and not empty.");this.storeName=e}},{key:"newsletter",value:function(e,t,r){var n=this,a={isNewsletterOptIn:void 0===t||t};return $.Deferred(function(t){if(!l.default.isEmail(e))return t.reject(n._parseError(i.default.error.ERR_INVALID_EMAIL));n._getByEmail(e,r).done(function(s){return n._resultOk(s)?n._partialUpdate(s[0].id,a,r).done(function(e){t.resolve(n._parseResult(e,i.default.operations.OP_UPDATE))}).fail(function(e){t.reject(n._parseResult(e))}):n._insert($.extend({email:e},a),r).done(function(e){t.resolve(n._parseResult(e,i.default.operations.OP_INSERT))}).fail(function(e){t.reject(n._parseResult(e))})}).fail(function(e){t.reject(n._parseError(e))})}).promise()}},{key:"getUser",value:function(e,t,r){var n=this;return $.Deferred(function(a){if(!l.default.isEmail(e))return a.reject(n._parseError(i.default.error.ERR_INVALID_EMAIL));n._getByEmail(e,r).done(function(e){if(n._resultOk(e))return n._get(e[0].id,t,r).done(function(e,t,r){a.resolve(n._parseResult(n._parseResponse(null,e,r.status),i.default.operations.OP_GET))}).fail(function(e){a.reject(n._parseResult(e))});a.reject(n._parseError(i.default.error.ERR_INVALID_USER))}).fail(function(e){a.reject(n._parseError(e))})}).promise()}},{key:"updateUser",value:function(e,t,r){var n=this;return $.Deferred(function(a){return l.default.isEmail(e)?n._getByEmail(e,r).done(function(e){if(n._resultOk(e))return n._partialUpdate(e[0].id,t,r).done(function(e){a.resolve(n._parseResult(e,i.default.operations.OP_UPDATE))}).fail(function(e){a.reject(e)});a.reject(n._parseError(i.default.error.ERR_INVALID_USER))}).fail(function(e){a.reject(n._parseError(e))}):a.reject(n._parseError(i.default.error.ERR_INVALID_EMAIL))}).promise()}},{key:"insertUpdateUser",value:function(e,t,r){var n=this;return $.Deferred(function(a){return l.default.isEmail(e)?n._getByEmail(e,r).done(function(s){return n._resultOk(s)?n._partialUpdate(s[0].id,t,r).done(function(e){a.resolve(n._parseResult(e,i.default.operations.OP_UPDATE))}).fail(function(e){a.reject(n._parseError(e))}):n._insert($.extend({email:e},t),r).done(function(e){a.resolve(n._parseResult(e,i.default.operations.OP_INSERT))}).fail(function(e){a.reject(n._parseError(e))})}).fail(function(e){a.reject(n._parseError(e))}):a.reject(n._parseError(i.default.error.ERR_INVALID_EMAIL))}).promise()}},{key:"insert",value:function(e,t){var r=this;return $.Deferred(function(n){return r._insert(e,t).done(function(e){n.resolve(r._parseResult(e,i.default.operations.OP_INSERT))}).fail(function(e){n.reject(r._parseError(e))})}).promise()}},{key:"insertUpdate",value:function(e,t,r){var n=this;return $.Deferred(function(a){return n._partialUpdate(e,t,r).done(function(e){a.resolve(n._parseResult(e,201===e.statusCode?i.default.operations.OP_INSERT:i.default.operations.OP_UPDATE))}).fail(function(e){a.reject(n._parseError(e))})}).promise()}},{key:"search",value:function(e,t,r,n,a){var s=this;return $.Deferred(function(o){return s._search(e,t,r,n,a).done(function(e,t,r){o.resolve(s._parseResult(s._parseResponse(null,e,r.status),i.default.operations.OP_GET))}).fail(function(e){o.reject(s._parseError(e))})}).promise()}},{key:"get",value:function(e,t,r){var n=this;return $.Deferred(function(a){return n._get(e,t,r).done(function(e,r,s){a.resolve(n._parseResult(n._parseResponse(t,e,s.status),i.default.operations.OP_GET))}).fail(function(e){a.reject(n._parseError(e))})}).promise()}},{key:"exists",value:function(e,t){var r=this;return $.Deferred(function(n){return r._call("get",e,{_fields:"id"},t,i.default.types.DOCUMENTS).done(function(e,t,a){void 0!==e&&void 0!==e.id?(n.resolve(r._parseResult(r._parseResponse(null,{id:e.id,exists:!0},a.status),i.default.operations.OP_GET)),n.resolve(r._parseResult(e,i.default.operations.OP_GET))):n.reject(!1)}).fail(function(e){n.reject(r._parseError(e))})}).promise()}},{key:"uploadFile",value:function(e,t,r,n){var a=this;return $.Deferred(function(s){return a._uploadAttachment(e,t,r,n).done(function(t,r,o){s.resolve(a._parseResult(a._parseResponse({DocummentId:e,filename:n.name},t,o.status),i.default.operations.OP_INSERT))}).fail(function(e){s.reject(a._parseError(e))})}).promise()}},{key:"_get",value:function(e,t,r){var n=["email","id"];t=t instanceof Array?l.default.arrayUnique(t.concat(["id"])):n;var a={_fields:t.join(",")};return this._call("get",e,a,r,i.default.types.DOCUMENTS)}},{key:"_insert",value:function(e,t){var r=this;return $.Deferred(function(n){return r._call("post",null,e,t,i.default.types.DOCUMENTS).done(function(t,a,s){n.resolve(r._parseResponse(e,t,s.status))}).fail(function(e){n.reject(e)})}).promise()}},{key:"_upload",value:function(e,t){var r=this;return $.Deferred(function(n){return r._call("post",null,e,t,i.default.types.DOCUMENTS).done(function(e,t,a){n.resolve(r._parseResponse(null,e,a.status))}).fail(function(e){n.reject(e)})}).promise()}},{key:"_uploadAttachment",value:function(e,t,r,n){var a=new FormData;return a.append("Filename",n.name),a.append("Filedata",n),this._callAttachment(e,a,t,r)}},{key:"_fullUpdate",value:function(e,t,r){return this._call("put",e,t,r,i.default.types.DOCUMENTS)}},{key:"_partialUpdate",value:function(e,t,r){var n=this;return $.Deferred(function(a){return n._call("patch",e,t,r,i.default.types.DOCUMENTS).done(function(e,r,s){a.resolve(n._parseResponse(t,e,s.status))}).fail(function(e){a.reject(e)})}).promise()}},{key:"_search",value:function(e,t,r,n,a){n=n||49,a=a||0;var s={"REST-Range":"resources="+a+"-"+(n+a)};return e._fields=t.join(","),this._call("get",null,e,r,i.default.types.SEARCH,s)}},{key:"_getByEmail",value:function(e,t){return this._search({email:e},["email","id"],t,1,0)}},{key:"_getURL",value:function(e,t,r){if(e=void 0!==e?e:i.default.DEFAULT_ENTITY,null===this.storeName)throw new Error("Store name is not set, vtexMasterdata.setStore(storeName) must be called.");return l.default.strReplace(["{storeName}","{entity}","{type}"],[this.storeName,e,t],i.default.API_URL)+(void 0!==r&&null!==r?r:"")}},{key:"_getAttachmentURL",value:function(e,t,r){if(e=void 0!==e?e:i.default.DEFAULT_ENTITY,null===this.storeName)throw new Error("Store name is not set, vtexMasterdata.setStore(storeName) must be called.");return l.default.strReplace(["{storeName}","{entity}","{id}","{field}"],[this.storeName,e,void 0!==t&&null!==t?t:"",r],i.default.API_ATTACHMENT_URL)}},{key:"_call",value:function(e,t,r,n,a,s){return $.ajax({url:this._getURL(n,a,t),type:e,accept:"application/vnd.vtex.ds.v10+json",contentType:"application/json; charset=utf-8",beforeSend:function(e){for(var t in s)e.setRequestHeader(t,s[t])},crossDomain:!0,data:"get"!==e&&null!==r?JSON.stringify(r):r})}},{key:"_callAttachment",value:function(e,t,r,n){return $.ajax({url:this._getAttachmentURL(r,e,n),type:"post",data:t,processData:!1,contentType:!1,crossDomain:!0,accept:"application/vnd.vtex.ds.v10+json",mimeType:"multipart/form-data"})}},{key:"_parseResponse",value:function(e,t,r){return{dataInsert:e,dataResponse:t,dataStatus:r}}},{key:"_resultOk",value:function(e){return void 0!==e&&e.length&&void 0!==e[0].id}},{key:"_parseResult",value:function(e,t){return new c.default(e,t)}},{key:"_parseError",value:function(e){return new d.default(e)}}]),e}();r.default=_},{"./../data/constants.js":4,"./../utils/helpers.js":6,"./VtexError.js":1,"./VtexSuccess.js":3}],3:[function(e,t,r){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(r,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),s=e("./../data/constants.js"),o=function(e){return e&&e.__esModule?e:{default:e}}(s),i=function(){function e(t,r){n(this,e),this.name="VtexMasterdata Success",this.result=t,this.operation=r}return a(e,[{key:"isOk",value:function(){return!0}},{key:"isInsert",value:function(){return this.operation==o.default.operations.OP_INSERT}},{key:"isUpdate",value:function(){return this.operation==o.default.operations.OP_UPDATE}},{key:"isGet",value:function(){return this.operation==o.default.operations.OP_GET}},{key:"getResults",value:function(){return this.result}},{key:"getResponse",value:function(){return this.result.dataResponse}},{key:"getStatus",value:function(){return this.result.dataStatus}}]),e}();r.default=i},{"./../data/constants.js":4}],4:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.default={API_URL:"//api.vtexcrm.com.br/{storeName}/dataentities/{entity}/{type}/",API_ATTACHMENT_URL:"//api.vtexcrm.com.br/{storeName}/dataentities/{entity}/documents/{id}/{field}/attachments",DEFAULT_ENTITY:"CL",error:{ERR_INVALID_USER:"User doesn't exist",ERR_INVALID_PARTNER:"Partner doesn't exist",ERR_INVALID_EMAIL:"Invalid email"},types:{DOCUMENTS:"documents",SEARCH:"search",SCHEMAS:"schemas",FACET:"search/facet",ATTACHMENT:"documents"},operations:{OP_GET:"get",OP_INSERT:"insert",OP_UPDATE:"update"}}},{}],5:[function(e,t,r){"use strict";var n=e("./class/VtexMasterdata.js"),a=function(e){return e&&e.__esModule?e:{default:e}}(n);void 0===window.VtexMasterdata&&(window.VtexMasterdata=a.default)},{"./class/VtexMasterdata.js":2}],6:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.default={arrayUnique:function(e){return e.filter(function(e,t,r){return r.indexOf(e)===t})},isEmail:function(e){return/^[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,4}$/i.test(e)},strReplace:function(e,t,r){var n=void 0;if(e instanceof Array)for(var a=0;a<e.length;a++)e[a]=e[a].replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),n=new RegExp(e[a],"g"),r=r.replace(n,t instanceof Array?t[a]:t);else e=e.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),n=new RegExp(e,"g"),r=r.replace(n,t instanceof Array?t[0]:t);return r}}},{}]},{},[5]);
