/*!!
 * VtexMasterdata.js v0.3.3
 * https://github.com/zeindelf/vtex-masterdata
 *
 * Copyright (c) 2017-2018 Zeindelf
 * Released under the MIT license
 *
 * Date: 2018-08-20T06:39:40.677Z
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e.VTEX=e.VTEX||{},e.VTEX.VtexMasterdata=t())}(this,function(){"use strict";var e="0.5.0",a={API_URL:"//api.vtexcrm.com.br/{storeName}/dataentities/{entity}/{type}/",API_ATTACHMENT_URL:"//api.vtexcrm.com.br/{storeName}/dataentities/{entity}/documents/{id}/{field}/attachments",DEFAULT_ENTITY:"CL",error:{ERR_INVALID_USER:"User doesn't exist",ERR_INVALID_PARTNER:"Partner doesn't exist",ERR_INVALID_EMAIL:"Invalid email"},types:{DOCUMENTS:"documents",SEARCH:"search",SCHEMAS:"schemas",FACET:"search/facet",ATTACHMENT:"documents"},operations:{OP_GET:"get",OP_INSERT:"insert",OP_UPDATE:"update"},messages:{vtexUtils:'VtexUtils.js is required and must be an instance. Download it from https://www.npmjs.com/package/vtex-utils and use "new VtexMasterdata(new VtexUtils())"',vtexUtilsVersion:e,vtexUtilsVersionMessage:"VtexUtils version must be higher than 0.5.0. Download last version on https://www.npmjs.com/package/vtex-utils",storeName:"Store name must be a string and not empty."}},n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},s=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},t=function(){function n(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(e,t,r){return t&&n(e.prototype,t),r&&n(e,r),e}}(),r=function(){function r(e,t){s(this,r),this.type="Success",this.result=e,this.operation=t}return t(r,[{key:"isOk",value:function(){return!0}},{key:"isInsert",value:function(){return this.operation==a.operations.OP_INSERT}},{key:"isUpdate",value:function(){return this.operation==a.operations.OP_UPDATE}},{key:"isGet",value:function(){return this.operation==a.operations.OP_GET}},{key:"getResults",value:function(){return this.result}},{key:"getResponse",value:function(){return this.result.dataResponse}},{key:"getStatus",value:function(){return this.result.dataStatus}}]),r}(),o=function(){function r(e){if(s(this,r),this.type="Error",this.response=null,this.message=null,"object"==(void 0===e?"undefined":n(e)))for(var t in e)e.hasOwnProperty(t)&&"function"!=typeof e[t]&&("responseText"==t&&(this.response=$.parseJSON(e[t])),"string"==typeof t&&"message"==t.toLowerCase()?this.message=e[t]:this[t]=e[t]);else"string"==typeof e&&(this.message=e)}return t(r,[{key:"isOk",value:function(){return!1}},{key:"getResponse",value:function(){return this.response}},{key:"getMessage",value:function(){return null!==this.message?this.message:null!==this.response&&void 0!==this.response.Message?this.response.Message:null}}]),r}(),l=new(function(){function e(){s(this,e),this._globalHelpers=null,this._vtexHelpers=null,this._storeName=null}return t(e,[{key:"_setStore",value:function(e){this._storeName=e}},{key:"_setHelpers",value:function(e,t){this._globalHelpers=e,this._vtexHelpers=t,this._storeName=this._vtexHelpers.getStoreName}},{key:"_get",value:function(e,t,r){this._validateStoreName();var n={_fields:(t=this._globalHelpers.isArray(t)?this._globalHelpers.arrayUnique(t.concat(["id"])):["id"]).join(",")};return this._call("get",e,n,r,a.types.DOCUMENTS)}},{key:"_insert",value:function(s,e){var o=this;return $.Deferred(function(n){return o._call("post",null,s,e,a.types.DOCUMENTS).done(function(e,t,r){n.resolve(o._parseResponse(s,e,r.status))}).fail(function(e){n.reject(e)})}).promise()}},{key:"_upload",value:function(e,t){var s=this;return $.Deferred(function(n){return s._call("post",null,e,t,a.types.DOCUMENTS).done(function(e,t,r){n.resolve(s._parseResponse(null,e,r.status))}).fail(function(e){n.reject(e)})}).promise()}},{key:"_uploadAttachment",value:function(e,t,r,n){var s=new FormData;return s.append("Filename",n.name),s.append("Filedata",n),this._callAttachment(e,s,t,r)}},{key:"_fullUpdate",value:function(e,t,r){return this._call("put",e,t,r,a.types.DOCUMENTS)}},{key:"_partialUpdate",value:function(e,s,t){var o=this;return $.Deferred(function(n){return o._call("patch",e,s,t,a.types.DOCUMENTS).done(function(e,t,r){n.resolve(o._parseResponse(s,e,r.status))}).fail(function(e){n.reject(e)})}).promise()}},{key:"_search",value:function(e,t,r,n,s){return this._performSearch(e,t,r,n,s,null)}},{key:"_fullSearch",value:function(e,t,r,n,s,o){return this._performSearch(e,t,n,s,o,r)}},{key:"_getByEmail",value:function(e,t){return this._search({email:e},["email","id"],t,1,0)}},{key:"_getURL",value:function(e,t,r){return this._validateStoreName(),e=this._globalHelpers.isUndefined(e)?a.DEFAULT_ENTITY:e,this._globalHelpers.strReplace(["{storeName}","{entity}","{type}"],[this._storeName,e,t],a.API_URL)+(null!=r?r:"")}},{key:"_getAttachmentURL",value:function(e,t,r){return this._validateStoreName(),e=this._globalHelpers.isUndefined(e)?a.DEFAULT_ENTITY:e,this._globalHelpers.strReplace(["{storeName}","{entity}","{id}","{field}"],[this._storeName,e,null!=t?t:"",r],a.API_ATTACHMENT_URL)}},{key:"_call",value:function(e,t,r,n,s,o){return $.ajax({url:this._getURL(n,s,t),type:e,accept:"application/vnd.vtex.ds.v10+json",contentType:"application/json; charset=utf-8",beforeSend:function(e){for(var t in o)({}).hasOwnProperty.call(o,t)&&e.setRequestHeader(t,o[t])},crossDomain:!0,data:"get"!==e&&null!==r?JSON.stringify(r):r})}},{key:"_callAttachment",value:function(e,t,r,n){return $.ajax({url:this._getAttachmentURL(r,e,n),type:"post",data:t,processData:!1,contentType:!1,crossDomain:!0,accept:"application/vnd.vtex.ds.v10+json",mimeType:"multipart/form-data"})}},{key:"_performSearch",value:function(e,t,r,n,s,o){this._validateStoreName();var i={"REST-Range":"resources="+(s=s||0)+"-"+((n=n||49)+s)};return t=this._globalHelpers.isArray(t)?this._globalHelpers.arrayUnique(t.concat(["id"])):["id"],e._fields=t.join(","),this._globalHelpers.isObject(o)&&(o.hasOwnProperty("_where")&&(e._where=o._where),o.hasOwnProperty("_keyword")&&(e._keyword=o._keyword),o.hasOwnProperty("_sort")&&(e._sort=o._sort)),this._call("get",null,e,r,a.types.SEARCH,i)}},{key:"_validateStoreName",value:function(){if(this._globalHelpers.isUndefined(this._storeName))throw new Error(a.messages.storeName)}},{key:"_parseResponse",value:function(e,t,r){return{dataInsert:e,dataResponse:t,dataStatus:r}}},{key:"_resultOk",value:function(e){return void 0!==e&&e.length&&void 0!==e[0].id}},{key:"_parseResult",value:function(e,t){return new r(e,t)}},{key:"_parseError",value:function(e){return new o(e)}}]),e}()),i={setStore:function(e){l._setStore(e),l._setHelpers(this.globalHelpers,this.vtexHelpers)},newsletter:function(r,e,n){var s=this,o={isNewsletterOptIn:!!this.globalHelpers.isUndefined(e)||e};return $.Deferred(function(t){if(!s.globalHelpers.isEmail(r))return t.reject(l._parseError(a.error.ERR_INVALID_EMAIL));l._getByEmail(r,n).done(function(e){return l._resultOk(e)?l._partialUpdate(e[0].id,o,n).done(function(e){t.resolve(l._parseResult(e,a.operations.OP_UPDATE))}).fail(function(e){t.reject(l._parseResult(e))}):l._insert($.extend({email:r},o),n).done(function(e){t.resolve(l._parseResult(e,a.operations.OP_INSERT))}).fail(function(e){t.reject(l._parseResult(e))})}).fail(function(e){t.reject(l._parseError(e))})}).promise()},getUser:function(e,t,r){var s=this;return $.Deferred(function(n){if(!s.globalHelpers.isEmail(e))return n.reject(l._parseError(a.error.ERR_INVALID_EMAIL));l._getByEmail(e,r).done(function(e){if(l._resultOk(e))return l._get(e[0].id,t,r).done(function(e,t,r){n.resolve(l._parseResult(l._parseResponse(null,e,r.status),a.operations.OP_GET))}).fail(function(e){n.reject(l._parseResult(e))});n.reject(l._parseError(a.error.ERR_INVALID_USER))}).fail(function(e){n.reject(l._parseError(e))})}).promise()},updateUser:function(e,r,n){var s=this;return $.Deferred(function(t){return s.globalHelpers.isEmail(e)?l._getByEmail(e,n).done(function(e){if(l._resultOk(e))return l._partialUpdate(e[0].id,r,n).done(function(e){t.resolve(l._parseResult(e,a.operations.OP_UPDATE))}).fail(function(e){t.reject(e)});t.reject(l._parseError(a.error.ERR_INVALID_USER))}).fail(function(e){t.reject(l._parseError(e))}):t.reject(l._parseError(a.error.ERR_INVALID_EMAIL))}).promise()},insertUpdateUser:function(r,n,s){var e=this;return $.Deferred(function(t){return e.globalHelpers.isEmail(r)?l._getByEmail(r,s).done(function(e){return l._resultOk(e)?l._partialUpdate(e[0].id,n,s).done(function(e){t.resolve(l._parseResult(e,a.operations.OP_UPDATE))}).fail(function(e){t.reject(l._parseError(e))}):l._insert($.extend({email:r},n),s).done(function(e){t.resolve(l._parseResult(e,a.operations.OP_INSERT))}).fail(function(e){t.reject(l._parseError(e))})}).fail(function(e){t.reject(l._parseError(e))}):t.reject(l._parseError(a.error.ERR_INVALID_EMAIL))}).promise()},insert:function(e,r){return $.Deferred(function(t){return l._insert(e,r).done(function(e){t.resolve(l._parseResult(e,a.operations.OP_INSERT))}).fail(function(e){t.reject(l._parseError(e))})}).promise()},insertUpdate:function(e,r,n){return $.Deferred(function(t){return l._partialUpdate(e,r,n).done(function(e){t.resolve(l._parseResult(e,201===e.dataStatus?a.operations.OP_INSERT:a.operations.OP_UPDATE))}).fail(function(e){t.reject(l._parseError(e))})}).promise()},search:function(e,t,r,s,o){return $.Deferred(function(n){return l._search(e,t,r,s,o).done(function(e,t,r){n.resolve(l._parseResult(l._parseResponse(null,e,r.status),a.operations.OP_GET))}).fail(function(e){n.reject(l._parseError(e))})}).promise()},fullSearch:function(e,t,r,s,o,i){return $.Deferred(function(n){return l._fullSearch(e,t,r,s,o,i).done(function(e,t,r){n.resolve(l._parseResult(l._parseResponse(null,e,r.status),a.operations.OP_GET))}).fail(function(e){n.reject(l._parseError(e))})}).promise()},get:function(e,t,r){return $.Deferred(function(n){return l._get(e,t,r).done(function(e,t,r){n.resolve(l._parseResult(l._parseResponse(null,e,r.status),a.operations.OP_GET))}).fail(function(e){n.reject(l._parseError(e))})}).promise()},exists:function(e,t){return $.Deferred(function(n){return l._call("get",e,{_fields:"id"},t,a.types.DOCUMENTS).done(function(e,t,r){void 0!==e&&void 0!==e.id?n.resolve(l._parseResult(l._parseResponse(null,{id:e.id,exists:!0},r.status),a.operations.OP_GET)):n.reject(!1)}).fail(function(e){n.reject(l._parseError(e))})}).promise()},uploadFile:function(s,e,t,o){return $.Deferred(function(n){return l._uploadAttachment(s,e,t,o).done(function(e,t,r){n.resolve(l._parseResult(l._parseResponse({DocummentId:s,filename:o.name},e,r.status),a.operations.OP_INSERT))}).fail(function(e){n.reject(l._parseError(e))})}).promise()}};return function e(t){if(s(this,e),this.version="0.3.3",this.name="@VtexMasterdata",void 0===t)throw new TypeError(a.messages.vtexUtils);if("@VtexUtils"!==t.name)throw new TypeError(a.messages.vtexUtils);if(t.version<a.messages.vtexUtilsVersion)throw new Error(a.messages.vtexUtilsVersionMessage);this.globalHelpers=t.globalHelpers,this.vtexHelpers=t.vtexHelpers,this.globalHelpers.extend(e.prototype,i)}});