/*!!
 * VtexMasterdata.js v0.2.0
 * https://github.com/zeindelf/vtex-masterdata
 *
 * Copyright (c) 2017-2018 Zeindelf
 * Released under the MIT license
 *
 * Date: 2018-01-07T23:30:33.491Z
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e.VTEX=e.VTEX||{},e.VTEX.VtexMasterdata=t())}(this,function(){"use strict";var e="//api.vtexcrm.com.br/{storeName}/dataentities/{entity}/{type}/",t="//api.vtexcrm.com.br/{storeName}/dataentities/{entity}/documents/{id}/{field}/attachments",r="CL",n={ERR_INVALID_USER:"User doesn't exist",ERR_INVALID_PARTNER:"Partner doesn't exist",ERR_INVALID_EMAIL:"Invalid email"},s={DOCUMENTS:"documents",SEARCH:"search",SCHEMAS:"schemas",FACET:"search/facet",ATTACHMENT:"documents"},i={OP_GET:"get",OP_INSERT:"insert",OP_UPDATE:"update"},o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},a=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},u=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),l=function(){function e(t,r){a(this,e),this.type="Success",this.result=t,this.operation=r}return u(e,[{key:"isOk",value:function(){return!0}},{key:"isInsert",value:function(){return this.operation==i.OP_INSERT}},{key:"isUpdate",value:function(){return this.operation==i.OP_UPDATE}},{key:"isGet",value:function(){return this.operation==i.OP_GET}},{key:"getResults",value:function(){return this.result}},{key:"getResponse",value:function(){return this.result.dataResponse}},{key:"getStatus",value:function(){return this.result.dataStatus}}]),e}(),c=function(){function e(t){if(a(this,e),this.type="Error",this.response=null,this.message=null,"object"==(void 0===t?"undefined":o(t)))for(var r in t)t.hasOwnProperty(r)&&"function"!=typeof t[r]&&("responseText"==r&&(this.response=$.parseJSON(t[r])),"string"==typeof r&&"message"==r.toLowerCase()?this.message=t[r]:this[r]=t[r]);else"string"==typeof t&&(this.message=t)}return u(e,[{key:"isOk",value:function(){return!1}},{key:"getResponse",value:function(){return this.response}},{key:"getMessage",value:function(){return null!==this.message?this.message:null!==this.response&&void 0!==this.response.Message?this.response.Message:null}}]),e}(),f=new(function(){function n(){a(this,n),this._globalHelpers=null,this._vtexHelpers=null,this._storeName=null}return u(n,[{key:"_setStore",value:function(e){this._storeName=e}},{key:"_setHelpers",value:function(e,t){this._globalHelpers=e,this._vtexHelpers=t}},{key:"_get",value:function(e,t,r){var n={_fields:(t=t instanceof Array?this._globalHelpers.arrayUnique(t.concat(["id"])):["email","id"]).join(",")};return this._call("get",e,n,r,s.DOCUMENTS)}},{key:"_insert",value:function(e,t){var r=this;return $.Deferred(function(n){return r._call("post",null,e,t,s.DOCUMENTS).done(function(t,s,i){n.resolve(r._parseResponse(e,t,i.status))}).fail(function(e){n.reject(e)})}).promise()}},{key:"_upload",value:function(e,t){var r=this;return $.Deferred(function(n){return r._call("post",null,e,t,s.DOCUMENTS).done(function(e,t,s){n.resolve(r._parseResponse(null,e,s.status))}).fail(function(e){n.reject(e)})}).promise()}},{key:"_uploadAttachment",value:function(e,t,r,n){var s=new FormData;return s.append("Filename",n.name),s.append("Filedata",n),this._callAttachment(e,s,t,r)}},{key:"_fullUpdate",value:function(e,t,r){return this._call("put",e,t,r,s.DOCUMENTS)}},{key:"_partialUpdate",value:function(e,t,r){var n=this;return $.Deferred(function(i){return n._call("patch",e,t,r,s.DOCUMENTS).done(function(e,r,s){i.resolve(n._parseResponse(t,e,s.status))}).fail(function(e){i.reject(e)})}).promise()}},{key:"_search",value:function(e,t,r,n,i){n=n||49;var o={"REST-Range":"resources="+(i=i||0)+"-"+(n+i)};return e._fields=t.join(","),this._call("get",null,e,r,s.SEARCH,o)}},{key:"_getByEmail",value:function(e,t){return this._search({email:e},["email","id"],t,1,0)}},{key:"_getURL",value:function(t,n,s){if(t=void 0!==t?t:r,null===this._storeName)throw new Error("Store name is not set, vtexMasterdata.setStore(storeName) must be called.");return this._globalHelpers.strReplace(["{storeName}","{entity}","{type}"],[this._storeName,t,n],e)+(void 0!==s&&null!==s?s:"")}},{key:"_getAttachmentURL",value:function(e,n,s){if(e=void 0!==e?e:r,null===this._storeName)throw new Error("Store name is not set, vtexMasterdata.setStore(storeName) must be called.");return this._globalHelpers.strReplace(["{storeName}","{entity}","{id}","{field}"],[this._storeName,e,void 0!==n&&null!==n?n:"",s],t)}},{key:"_call",value:function(e,t,r,n,s,i){return $.ajax({url:this._getURL(n,s,t),type:e,accept:"application/vnd.vtex.ds.v10+json",contentType:"application/json; charset=utf-8",beforeSend:function(e){for(var t in i)({}).hasOwnProperty.call(i,t)&&e.setRequestHeader(t,i[t])},crossDomain:!0,data:"get"!==e&&null!==r?JSON.stringify(r):r})}},{key:"_callAttachment",value:function(e,t,r,n){return $.ajax({url:this._getAttachmentURL(r,e,n),type:"post",data:t,processData:!1,contentType:!1,crossDomain:!0,accept:"application/vnd.vtex.ds.v10+json",mimeType:"multipart/form-data"})}},{key:"_parseResponse",value:function(e,t,r){return{dataInsert:e,dataResponse:t,dataStatus:r}}},{key:"_resultOk",value:function(e){return void 0!==e&&e.length&&void 0!==e[0].id}},{key:"_parseResult",value:function(e,t){return new l(e,t)}},{key:"_parseError",value:function(e){return new c(e)}}]),n}()),p={setStore:function(e){if("string"!=typeof e||0===e.length)throw new Error("Store name must be a string and not empty.");f._setStore(e),f._setHelpers(this.globalHelpers,this.vtexHelpers)},newsletter:function(e,t,r){var s=this,o={isNewsletterOptIn:void 0===t||t};return $.Deferred(function(t){if(!s.globalHelpers.isEmail(e))return t.reject(f._parseError(n.ERR_INVALID_EMAIL));f._getByEmail(e,r).done(function(n){return f._resultOk(n)?f._partialUpdate(n[0].id,o,r).done(function(e){t.resolve(f._parseResult(e,i.OP_UPDATE))}).fail(function(e){t.reject(f._parseResult(e))}):f._insert($.extend({email:e},o),r).done(function(e){t.resolve(f._parseResult(e,i.OP_INSERT))}).fail(function(e){t.reject(f._parseResult(e))})}).fail(function(e){t.reject(f._parseError(e))})}).promise()},getUser:function(e,t,r){var s=this;return $.Deferred(function(o){if(!s.globalHelpers.isEmail(e))return o.reject(f._parseError(n.ERR_INVALID_EMAIL));f._getByEmail(e,r).done(function(e){if(f._resultOk(e))return f._get(e[0].id,t,r).done(function(e,t,r){o.resolve(f._parseResult(f._parseResponse(null,e,r.status),i.OP_GET))}).fail(function(e){o.reject(f._parseResult(e))});o.reject(f._parseError(n.ERR_INVALID_USER))}).fail(function(e){o.reject(f._parseError(e))})}).promise()},updateUser:function(e,t,r){var s=this;return $.Deferred(function(o){return s.globalHelpers.isEmail(e)?f._getByEmail(e,r).done(function(e){if(f._resultOk(e))return f._partialUpdate(e[0].id,t,r).done(function(e){o.resolve(f._parseResult(e,i.OP_UPDATE))}).fail(function(e){o.reject(e)});o.reject(f._parseError(n.ERR_INVALID_USER))}).fail(function(e){o.reject(f._parseError(e))}):o.reject(f._parseError(n.ERR_INVALID_EMAIL))}).promise()},insertUpdateUser:function(e,t,r){var s=this;return $.Deferred(function(o){return s.globalHelpers.isEmail(e)?f._getByEmail(e,r).done(function(n){return f._resultOk(n)?f._partialUpdate(n[0].id,t,r).done(function(e){o.resolve(f._parseResult(e,i.OP_UPDATE))}).fail(function(e){o.reject(f._parseError(e))}):f._insert($.extend({email:e},t),r).done(function(e){o.resolve(f._parseResult(e,i.OP_INSERT))}).fail(function(e){o.reject(f._parseError(e))})}).fail(function(e){o.reject(f._parseError(e))}):o.reject(f._parseError(n.ERR_INVALID_EMAIL))}).promise()},insert:function(e,t){return $.Deferred(function(r){return f._insert(e,t).done(function(e){r.resolve(f._parseResult(e,i.OP_INSERT))}).fail(function(e){r.reject(f._parseError(e))})}).promise()},insertUpdate:function(e,t,r){return $.Deferred(function(n){return f._partialUpdate(e,t,r).done(function(e){n.resolve(f._parseResult(e,201===e.statusCode?i.OP_INSERT:i.OP_UPDATE))}).fail(function(e){n.reject(f._parseError(e))})}).promise()},search:function(e,t,r,n,s){return $.Deferred(function(o){return f._search(e,t,r,n,s).done(function(e,t,r){o.resolve(f._parseResult(f._parseResponse(null,e,r.status),i.OP_GET))}).fail(function(e){o.reject(f._parseError(e))})}).promise()},get:function(e,t,r){return $.Deferred(function(n){return f._get(e,t,r).done(function(e,r,s){n.resolve(f._parseResult(f._parseResponse(t,e,s.status),i.OP_GET))}).fail(function(e){n.reject(f._parseError(e))})}).promise()},exists:function(e,t){return $.Deferred(function(r){return f._call("get",e,{_fields:"id"},t,s.DOCUMENTS).done(function(e,t,n){void 0!==e&&void 0!==e.id?(r.resolve(f._parseResult(f._parseResponse(null,{id:e.id,exists:!0},n.status),i.OP_GET)),r.resolve(f._parseResult(e,i.OP_GET))):r.reject(!1)}).fail(function(e){r.reject(f._parseError(e))})}).promise()},uploadFile:function(e,t,r,n){return $.Deferred(function(s){return f._uploadAttachment(e,t,r,n).done(function(t,r,o){s.resolve(f._parseResult(f._parseResponse({DocummentId:e,filename:n.name},t,o.status),i.OP_INSERT))}).fail(function(e){s.reject(f._parseError(e))})}).promise()}};return function e(t){if(a(this,e),this.version="0.2.0",this.name="@VtexMasterdata",void 0===t)throw new Error('VtexUtils.js is required and must be an instance. Download it from https://www.npmjs.com/package/vtex-utils and use "new VtexMasterdata(new VtexUtils())"');if("@VtexUtils"!==t.name)throw new Error('VtexUtils must be an instance. Use "new VtexMasterdata(new VtexUtils())"');this.globalHelpers=t.globalHelpers,this.vtexHelpers=t.vtexHelpers,this.globalHelpers.extend(e.prototype,p)}});