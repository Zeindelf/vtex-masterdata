/*!!
 * VtexMasterdata.js v0.3.0
 * https://github.com/zeindelf/vtex-masterdata
 *
 * Copyright (c) 2017-2018 Zeindelf
 * Released under the MIT license
 *
 * Date: 2018-01-22T03:01:34.036Z
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e.VTEX=e.VTEX||{},e.VTEX.VtexMasterdata=t())}(this,function(){"use strict";var e={API_URL:"//api.vtexcrm.com.br/{storeName}/dataentities/{entity}/{type}/",API_ATTACHMENT_URL:"//api.vtexcrm.com.br/{storeName}/dataentities/{entity}/documents/{id}/{field}/attachments",DEFAULT_ENTITY:"CL",error:{ERR_INVALID_USER:"User doesn't exist",ERR_INVALID_PARTNER:"Partner doesn't exist",ERR_INVALID_EMAIL:"Invalid email"},types:{DOCUMENTS:"documents",SEARCH:"search",SCHEMAS:"schemas",FACET:"search/facet",ATTACHMENT:"documents"},operations:{OP_GET:"get",OP_INSERT:"insert",OP_UPDATE:"update"},messages:{vtexUtils:'VtexUtils.js is required and must be an instance. Download it from https://www.npmjs.com/package/vtex-utils and use "new VtexMasterdata(new VtexUtils())"',vtexUtilsVersion:"0.5.0",vtexUtilsVersionMessage:"VtexUtils version must be higher than 0.5.0. Download last version on https://www.npmjs.com/package/vtex-utils",storeName:"Store name must be a string and not empty."}},t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),s=function(){function t(e,n){r(this,t),this.type="Success",this.result=e,this.operation=n}return n(t,[{key:"isOk",value:function(){return!0}},{key:"isInsert",value:function(){return this.operation==e.operations.OP_INSERT}},{key:"isUpdate",value:function(){return this.operation==e.operations.OP_UPDATE}},{key:"isGet",value:function(){return this.operation==e.operations.OP_GET}},{key:"getResults",value:function(){return this.result}},{key:"getResponse",value:function(){return this.result.dataResponse}},{key:"getStatus",value:function(){return this.result.dataStatus}}]),t}(),o=function(){function e(n){if(r(this,e),this.type="Error",this.response=null,this.message=null,"object"==(void 0===n?"undefined":t(n)))for(var s in n)n.hasOwnProperty(s)&&"function"!=typeof n[s]&&("responseText"==s&&(this.response=$.parseJSON(n[s])),"string"==typeof s&&"message"==s.toLowerCase()?this.message=n[s]:this[s]=n[s]);else"string"==typeof n&&(this.message=n)}return n(e,[{key:"isOk",value:function(){return!1}},{key:"getResponse",value:function(){return this.response}},{key:"getMessage",value:function(){return null!==this.message?this.message:null!==this.response&&void 0!==this.response.Message?this.response.Message:null}}]),e}(),i=new(function(){function t(){r(this,t),this._globalHelpers=null,this._vtexHelpers=null,this._storeName=null}return n(t,[{key:"_setStore",value:function(e){this._storeName=e}},{key:"_setHelpers",value:function(e,t){this._globalHelpers=e,this._vtexHelpers=t}},{key:"_get",value:function(t,r,n){this._validateStoreName();var s={_fields:(r=this._globalHelpers.isArray(r)?this._globalHelpers.arrayUnique(r.concat(["id"])):["id"]).join(",")};return this._call("get",t,s,n,e.types.DOCUMENTS)}},{key:"_insert",value:function(t,r){var n=this;return $.Deferred(function(s){return n._call("post",null,t,r,e.types.DOCUMENTS).done(function(e,r,o){s.resolve(n._parseResponse(t,e,o.status))}).fail(function(e){s.reject(e)})}).promise()}},{key:"_upload",value:function(t,r){var n=this;return $.Deferred(function(s){return n._call("post",null,t,r,e.types.DOCUMENTS).done(function(e,t,r){s.resolve(n._parseResponse(null,e,r.status))}).fail(function(e){s.reject(e)})}).promise()}},{key:"_uploadAttachment",value:function(e,t,r,n){var s=new FormData;return s.append("Filename",n.name),s.append("Filedata",n),this._callAttachment(e,s,t,r)}},{key:"_fullUpdate",value:function(t,r,n){return this._call("put",t,r,n,e.types.DOCUMENTS)}},{key:"_partialUpdate",value:function(t,r,n){var s=this;return $.Deferred(function(o){return s._call("patch",t,r,n,e.types.DOCUMENTS).done(function(e,t,n){o.resolve(s._parseResponse(r,e,n.status))}).fail(function(e){o.reject(e)})}).promise()}},{key:"_search",value:function(e,t,r,n,s){return this._performSearch(e,t,r,n,s,null)}},{key:"_fullSearch",value:function(e,t,r,n,s,o){return this._performSearch(e,t,n,s,o,r)}},{key:"_getByEmail",value:function(e,t){return this._search({email:e},["email","id"],t,1,0)}},{key:"_getURL",value:function(t,r,n){return this._validateStoreName(),t=this._globalHelpers.isUndefined(t)?e.DEFAULT_ENTITY:t,this._globalHelpers.strReplace(["{storeName}","{entity}","{type}"],[this._storeName,t,r],e.API_URL)+(void 0!==n&&null!==n?n:"")}},{key:"_getAttachmentURL",value:function(t,r,n){return this._validateStoreName(),t=this._globalHelpers.isUndefined(t)?e.DEFAULT_ENTITY:t,this._globalHelpers.strReplace(["{storeName}","{entity}","{id}","{field}"],[this._storeName,t,void 0!==r&&null!==r?r:"",n],e.API_ATTACHMENT_URL)}},{key:"_call",value:function(e,t,r,n,s,o){return $.ajax({url:this._getURL(n,s,t),type:e,accept:"application/vnd.vtex.ds.v10+json",contentType:"application/json; charset=utf-8",beforeSend:function(e){for(var t in o)({}).hasOwnProperty.call(o,t)&&e.setRequestHeader(t,o[t])},crossDomain:!0,data:"get"!==e&&null!==r?JSON.stringify(r):r})}},{key:"_callAttachment",value:function(e,t,r,n){return $.ajax({url:this._getAttachmentURL(r,e,n),type:"post",data:t,processData:!1,contentType:!1,crossDomain:!0,accept:"application/vnd.vtex.ds.v10+json",mimeType:"multipart/form-data"})}},{key:"_performSearch",value:function(t,r,n,s,o,i){this._validateStoreName(),s=s||49;var a={"REST-Range":"resources="+(o=o||0)+"-"+(s+o)};return r=this._globalHelpers.isArray(r)?this._globalHelpers.arrayUnique(r.concat(["id"])):["id"],t._fields=r.join(","),this._globalHelpers.isObject(i)&&(i.hasOwnProperty("_where")&&(t._where=i._where),i.hasOwnProperty("_keyword")&&(t._keyword=i._keyword),i.hasOwnProperty("_sort")&&(t._sort=i._sort)),this._call("get",null,t,n,e.types.SEARCH,a)}},{key:"_validateStoreName",value:function(){if(null===this._storeName)throw new Error(e.messages.storeName)}},{key:"_parseResponse",value:function(e,t,r){return{dataInsert:e,dataResponse:t,dataStatus:r}}},{key:"_resultOk",value:function(e){return void 0!==e&&e.length&&void 0!==e[0].id}},{key:"_parseResult",value:function(e,t){return new s(e,t)}},{key:"_parseError",value:function(e){return new o(e)}}]),t}()),a={setStore:function(e){i._setStore(e),i._setHelpers(this.globalHelpers,this.vtexHelpers)},newsletter:function(t,r,n){var s=this,o={isNewsletterOptIn:!!this.globalHelpers.isUndefined(r)||r};return $.Deferred(function(r){if(!s.globalHelpers.isEmail(t))return r.reject(i._parseError(e.error.ERR_INVALID_EMAIL));i._getByEmail(t,n).done(function(s){return i._resultOk(s)?i._partialUpdate(s[0].id,o,n).done(function(t){r.resolve(i._parseResult(t,e.operations.OP_UPDATE))}).fail(function(e){r.reject(i._parseResult(e))}):i._insert($.extend({email:t},o),n).done(function(t){r.resolve(i._parseResult(t,e.operations.OP_INSERT))}).fail(function(e){r.reject(i._parseResult(e))})}).fail(function(e){r.reject(i._parseError(e))})}).promise()},getUser:function(t,r,n){var s=this;return $.Deferred(function(o){if(!s.globalHelpers.isEmail(t))return o.reject(i._parseError(e.error.ERR_INVALID_EMAIL));i._getByEmail(t,n).done(function(t){if(i._resultOk(t))return i._get(t[0].id,r,n).done(function(t,r,n){o.resolve(i._parseResult(i._parseResponse(null,t,n.status),e.operations.OP_GET))}).fail(function(e){o.reject(i._parseResult(e))});o.reject(i._parseError(e.error.ERR_INVALID_USER))}).fail(function(e){o.reject(i._parseError(e))})}).promise()},updateUser:function(t,r,n){var s=this;return $.Deferred(function(o){return s.globalHelpers.isEmail(t)?i._getByEmail(t,n).done(function(t){if(i._resultOk(t))return i._partialUpdate(t[0].id,r,n).done(function(t){o.resolve(i._parseResult(t,e.operations.OP_UPDATE))}).fail(function(e){o.reject(e)});o.reject(i._parseError(e.error.ERR_INVALID_USER))}).fail(function(e){o.reject(i._parseError(e))}):o.reject(i._parseError(e.error.ERR_INVALID_EMAIL))}).promise()},insertUpdateUser:function(t,r,n){var s=this;return $.Deferred(function(o){return s.globalHelpers.isEmail(t)?i._getByEmail(t,n).done(function(s){return i._resultOk(s)?i._partialUpdate(s[0].id,r,n).done(function(t){o.resolve(i._parseResult(t,e.operations.OP_UPDATE))}).fail(function(e){o.reject(i._parseError(e))}):i._insert($.extend({email:t},r),n).done(function(t){o.resolve(i._parseResult(t,e.operations.OP_INSERT))}).fail(function(e){o.reject(i._parseError(e))})}).fail(function(e){o.reject(i._parseError(e))}):o.reject(i._parseError(e.error.ERR_INVALID_EMAIL))}).promise()},insert:function(t,r){return $.Deferred(function(n){return i._insert(t,r).done(function(t){n.resolve(i._parseResult(t,e.operations.OP_INSERT))}).fail(function(e){n.reject(i._parseError(e))})}).promise()},insertUpdate:function(t,r,n){return $.Deferred(function(s){return i._partialUpdate(t,r,n).done(function(t){s.resolve(i._parseResult(t,201===t.dataStatus?e.operations.OP_INSERT:e.operations.OP_UPDATE))}).fail(function(e){s.reject(i._parseError(e))})}).promise()},search:function(t,r,n,s,o){return $.Deferred(function(a){return i._search(t,r,n,s,o).done(function(t,r,n){a.resolve(i._parseResult(i._parseResponse(null,t,n.status),e.operations.OP_GET))}).fail(function(e){a.reject(i._parseError(e))})}).promise()},fullSearch:function(t,r,n,s,o,a){return $.Deferred(function(l){return i._fullSearch(t,r,n,s,o,a).done(function(t,r,n){l.resolve(i._parseResult(i._parseResponse(null,t,n.status),e.operations.OP_GET))}).fail(function(e){l.reject(i._parseError(e))})}).promise()},get:function(t,r,n){return $.Deferred(function(s){return i._get(t,r,n).done(function(t,r,n){s.resolve(i._parseResult(i._parseResponse(null,t,n.status),e.operations.OP_GET))}).fail(function(e){s.reject(i._parseError(e))})}).promise()},exists:function(t,r){return $.Deferred(function(n){return i._call("get",t,{_fields:"id"},r,e.types.DOCUMENTS).done(function(t,r,s){void 0!==t&&void 0!==t.id?n.resolve(i._parseResult(i._parseResponse(null,{id:t.id,exists:!0},s.status),e.operations.OP_GET)):n.reject(!1)}).fail(function(e){n.reject(i._parseError(e))})}).promise()},uploadFile:function(t,r,n,s){return $.Deferred(function(o){return i._uploadAttachment(t,r,n,s).done(function(r,n,a){o.resolve(i._parseResult(i._parseResponse({DocummentId:t,filename:s.name},r,a.status),e.operations.OP_INSERT))}).fail(function(e){o.reject(i._parseError(e))})}).promise()}};return function t(n){if(r(this,t),this.version="0.3.0",this.name="@VtexMasterdata",void 0===n)throw new TypeError(e.messages.vtexUtils);if("@VtexUtils"!==n.name)throw new TypeError(e.messages.vtexUtils);if(n.version<e.messages.vtexUtilsVersion)throw new Error(e.messages.vtexUtilsVersionMessage);this.globalHelpers=n.globalHelpers,this.vtexHelpers=n.vtexHelpers,this.globalHelpers.extend(t.prototype,a)}});